---
title: OverTheWire - Natas (11-20)
date: 2024-01-09
categories: [OverTheWire, Natas]
tags: [overthewire, natas, web-security]
img_path: /assets/overthewire/natas
published: true
image:
    path: natas.jpg
---

---

<center> <a href="https://cspanias.github.io/posts/OverTheWire-Natas-(0-10)">[Level 0-10]</a> </center>

---

## [Level 10 &rarr; 11](https://overthewire.org/wargames/natas/natas11.html)

> Password: 1KFqoJXi6hRaPluAmk8ESDW4fSysRoIg

![](natas11_home.png)

This level mentions that the "_Cookies are protected with **XOR encryption**_" and gives us the ability to customize the background colour. The source code involves five functions:

> [XOR Encryption Algorithm](https://www.101computing.net/xor-encryption-algorithm/)

1. The following code line defines the variable `defaultdata` which is an array of what we are basically see in the homepage, that is, while background and the inability to see the password:

    ```php
    $defaultdata = array( "showpassword"=>"no", "bgcolor"=>"#ffffff");
    ```

2. The `xor_encrypt` method, as the name suggests, XOR encrypts an input. The key is _censored_, so finding this will be our main goal. What it actually does is declaring a predefined key, assigning the input to the `text` variable, and store the result of the XOR bitwise operation (`text ^ key`) in the `outText` variable:

    > [PHP bitwise operators](https://www.geeksforgeeks.org/php-bitwise-operators/).

    ```php
    function xor_encrypt($in) {
        $key = '<censored>';
        $text = $in;
        $outText = '';

        // Iterate through each character
        for($i=0;$i<strlen($text);$i++) {
        $outText .= $text[$i] ^ $key[$i % strlen($key)];
        }

        return $outText;
    }
    ```

3. The `loadData` method takes the **cookie value**, decodes it, and then uses it to set web page values, such as the background color and the visibility of the password. If there is a `data` array from the browser cookie, its value is **base64** decoded, then **XOR encrypted**, and then **JSON** decoded. Then the `bgcocol` is read out of the array and checked against a hex color regex. If the `showpassword` key exists, it is also copied over to the `mydata` value:

> **XOR encryption** is the same with **XOR decryption** since XOR is reversible with the same mathematical function.

    ```php
    function loadData($def) {
        global $_COOKIE;
        $mydata = $def;
        if(array_key_exists("data", $_COOKIE)) {
        $tempdata = json_decode(xor_encrypt(base64_decode($_COOKIE["data"])), true);
        if(is_array($tempdata) && array_key_exists("showpassword", $tempdata) && array_key_exists("bgcolor", $tempdata)) {
            if (preg_match('/^#(?:[a-f\d]{6})$/i', $tempdata['bgcolor'])) {
            $mydata['showpassword'] = $tempdata['showpassword'];
            $mydata['bgcolor'] = $tempdata['bgcolor'];
            }
        }
        }
        return $mydata;
    }
    ```

4. The `saveData` function base64 encodes, XOR encrypts and JSON encodes the data array and saves it as a cookie in the user's browser:

    ```php
    function saveData($d) {
        setcookie("data", base64_encode(xor_encrypt(json_encode($d))));
    }
    ```

5. The below code lines request from the user to input the `bgcolor` value:

    ```php
    if(array_key_exists("bgcolor",$_REQUEST)) {
        if (preg_match('/^#(?:[a-f\d]{6})$/i', $_REQUEST['bgcolor'])) {
            $data['bgcolor'] = $_REQUEST['bgcolor'];
        }
    }
    ```

6. The last function, `saveData` is called with the default values loaded in:

    ```php
    $data = loadData($defaultdata);
    saveData($data);
    ```

We can first find our session's cookie value via the Inspector tool, which is `MGw7JCQ5OC04PT8jOSpqdmkgJ25nbCorKCEkIzlscm5oKC4qLSgubjY%3D`:

![](natas11_sessionCookie.png)

If we visit [CyberChef](https://gchq.github.io/CyberChef/) and URL decode our cookie we get the following:

![](natas11_urlDecode.png)

From breaking down the function, we know the the cookie value includes `showpassword=no` and our goal is to change it to `showpassword=yes`. Our cookie was generated by `setcookie("data", base64_encode(xor_encrypt(json_encode($d))));`. The problem is that we don't do the key for performing the XOR encryption!

We can use a [PHP compiler](https://www.w3schools.com/php/phptryit.asp?filename=tryphp_compiler&ref=learnhacking.io) and copy paste some of the functions in order to make our own cookie:

![](natas11_phpCompiler.png)

We have the cookie value of `eyJzaG93cGFzc3dvcmQiOiJubyIsImJnY29sb3IiOiIjZmZmZmZmIn0=`, while the XOR encoded cookie is `MGw7JCQ5OC04PT8jOSpqdmkgJ25nbCorKCEkIzlscm5oKC4qLSgubjY=`. 

The former is generated with the same exact values as the latter: ` showpassword: no, bgColor: #ffffff`. Because of the [associative property of XOR](https://accu.org/journals/overload/20/109/lewin_1915/?ref=learnhacking.io), it does not matter what order we do XOR in, we should get the same answer:
1. plaintext XOR key = ciphertext
2. ciphertext XOR key = plaintext
3. **ciphertext XOR plaintext = key**

We have both the ciphertext (`MGw7JCQ5OC04PT8jOSpqdmkgJ25nbCorKCEkIzlscm5oKC4qLSgubjY=`) and then plaintext (`eyJzaG93cGFzc3dvcmQiOiJubyIsImJnY29sb3IiOiIjZmZmZmZmIn0=`), so by performing a XOR operation between them we can get the key, and then use it to create a new cookie value and encrypt it:

![](natas11_xorDecoding.png)

This gives us the value `KNHL` as the XOR key. We can confirm this as follows:

![](natas11_xorDecoding1.png)

Now, we can make a new cookie with the JSON object `{"showpassword":"yes","bgcolor":"#ffffff"}`, XOR encrypt it, and then base64 encode it:

![](natas11_cookieFinal.png)

We can finally change our session cookie and get the password for the next level:

![](natas11_pass.png)

## [Level 11 &rarr; 12](https://overthewire.org/wargames/natas/natas12.html)

> Password: YWqo0pjpcXzSIl5NMAVxg12QxeC1w9QG

<!--
---

<center> <a href="https://cspanias.github.io/posts/OverTheWire-Natas-(21-34)/">[Level 21-34]</a> </center>

---
-->